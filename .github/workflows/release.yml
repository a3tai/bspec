name: Release BSpec

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Type of version bump'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
      create_release:
        description: 'Create GitHub release'
        required: true
        default: true
        type: boolean
      deploy_web:
        description: 'Deploy website after release'
        required: true
        default: true
        type: boolean
      deploy_mcp:
        description: 'Deploy MCP server after release'
        required: true
        default: true
        type: boolean

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  GO_VERSION: '1.21'

jobs:
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new-version: ${{ steps.bump.outputs.new-version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: Bump version
      id: bump
      run: |
        echo "ðŸš€ Bumping version with: ${{ github.event.inputs.version_bump }}"
        
        CURRENT_VERSION=$(cat spec/v1/version.txt)
        echo "current-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        
        python3 scripts/bump-version.py ${{ github.event.inputs.version_bump }}
        
        NEW_VERSION=$(cat spec/v1/version.txt)
        echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
        
        echo "âœ… Version bumped: $CURRENT_VERSION â†’ $NEW_VERSION"
        
    - name: Generate changelog
      run: |
        NEW_VERSION=${{ steps.bump.outputs.new-version }}
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        echo "## BSpec v$NEW_VERSION" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        
        if [[ -n "$LAST_TAG" ]]; then
          echo "### Changes since $LAST_TAG" >> CHANGELOG.md
          git log $LAST_TAG..HEAD --oneline --pretty=format:"- %s" >> CHANGELOG.md
        else
          echo "Initial release of BSpec v$NEW_VERSION" >> CHANGELOG.md
        fi
        
    - name: Commit and tag
      run: |
        NEW_VERSION=${{ steps.bump.outputs.new-version }}
        
        git add -A
        git commit -m "bump: version $NEW_VERSION"
        git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"
        
    - name: Push changes
      run: |
        git push origin main
        git push origin --tags

  build-cli:
    name: Build CLI (${{ matrix.os }}-${{ matrix.arch }})
    needs: bump-version
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-latest
          - os: linux
            arch: arm64
            runner: ubuntu-latest
          - os: darwin
            arch: amd64
            runner: macos-latest
          - os: darwin
            arch: arm64
            runner: macos-latest
          - os: windows
            arch: amd64
            runner: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        ref: v${{ needs.bump-version.outputs.new-version }}
        
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Build CLI
      shell: bash
      run: |
        cd sdk/cli
        VERSION=${{ needs.bump-version.outputs.new-version }}
        BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
        GIT_COMMIT=$(git rev-parse --short HEAD)
        
        LDFLAGS="-X github.com/a3tai/bspec/cli/internal/commands.Version=$VERSION"
        LDFLAGS="$LDFLAGS -X github.com/a3tai/bspec/cli/internal/commands.BuildDate=$BUILD_DATE"
        LDFLAGS="$LDFLAGS -X github.com/a3tai/bspec/cli/internal/commands.GitCommit=$GIT_COMMIT"
        
        mkdir -p bin
        
        if [[ "${{ matrix.os }}" == "windows" ]]; then
          CGO_ENABLED=0 GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} \
            go build -ldflags "$LDFLAGS" -o bin/bspec-${{ matrix.os }}-${{ matrix.arch }}.exe ./cmd/bspec
        else
          CGO_ENABLED=0 GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} \
            go build -ldflags "$LDFLAGS" -o bin/bspec-${{ matrix.os }}-${{ matrix.arch }} ./cmd/bspec
        fi
        
        ls -la bin/
        
    - name: Upload CLI artifact
      uses: actions/upload-artifact@v4
      with:
        name: bspec-${{ matrix.os }}-${{ matrix.arch }}
        path: sdk/cli/bin/bspec-*
        retention-days: 1

  create-release:
    name: Create GitHub Release
    needs: [bump-version, build-cli]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: github.event.inputs.create_release == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        ref: v${{ needs.bump-version.outputs.new-version }}
        
    - name: Download all CLI artifacts
      uses: actions/download-artifact@v7
      with:
        path: cli-binaries
        pattern: bspec-*
        merge-multiple: true
        
    - name: List artifacts
      run: |
        echo "ðŸ“¦ CLI Binaries:"
        ls -la cli-binaries/
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.bump-version.outputs.new-version }}
        name: BSpec v${{ needs.bump-version.outputs.new-version }}
        body: |
          ## BSpec v${{ needs.bump-version.outputs.new-version }}
          
          ### Downloads
          
          #### CLI Tool
          | Platform | Architecture | Download |
          |----------|--------------|----------|
          | macOS | Apple Silicon (M1/M2/M3) | `bspec-darwin-arm64` |
          | macOS | Intel | `bspec-darwin-amd64` |
          | Linux | x86_64 | `bspec-linux-amd64` |
          | Linux | ARM64 | `bspec-linux-arm64` |
          | Windows | x64 | `bspec-windows-amd64.exe` |
          
          #### Quick Install
          ```bash
          # macOS/Linux
          curl -sSL https://github.com/a3tai/bspec/releases/download/v${{ needs.bump-version.outputs.new-version }}/bspec-$(uname -s | tr '[:upper:]' '[:lower:]')-$(uname -m | sed 's/x86_64/amd64/' | sed 's/aarch64/arm64/') -o bspec
          chmod +x bspec
          sudo mv bspec /usr/local/bin/
          ```
          
          ### Links
          - ðŸ“š Documentation: https://bspec.dev
          - ðŸ”Œ MCP Server: https://mcp.bspec.dev/mcp
          - ðŸ“– Specification: https://bspec.dev/spec/v1-0-0
          
          ---
          Release triggered by @${{ github.actor }}
        files: cli-binaries/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-web:
    name: Deploy Website
    needs: [bump-version, create-release]
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_web == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        ref: v${{ needs.bump-version.outputs.new-version }}

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Generate web docs
      run: python3 scripts/generate_web_docs.py

    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - name: Install and build
      working-directory: apps/web
      run: |
        bun install
        bun run build

    - name: Deploy to Cloudflare Pages
      uses: cloudflare/pages-action@v1
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: bspec-docs
        directory: apps/web/.vitepress/dist
        gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  deploy-mcp:
    name: Deploy MCP Server
    needs: [bump-version, create-release]
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_mcp == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        ref: v${{ needs.bump-version.outputs.new-version }}

    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - name: Install and build
      working-directory: apps/mcp
      run: |
        bun install
        bun run build

    - name: Deploy to Cloudflare Workers
      working-directory: apps/mcp
      run: npx wrangler deploy --env production
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  summary:
    name: Release Summary
    needs: [bump-version, build-cli, create-release, deploy-web, deploy-mcp]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "ðŸŽ‰ BSpec Release Summary"
        echo "========================"
        echo ""
        echo "ðŸ“¦ Version: v${{ needs.bump-version.outputs.new-version }}"
        echo "ðŸ”„ Bump Type: ${{ github.event.inputs.version_bump }}"
        echo "ðŸ‘¤ Triggered by: ${{ github.actor }}"
        echo ""
        echo "Results:"
        echo "  - Version Bump: ${{ needs.bump-version.result }}"
        echo "  - CLI Build: ${{ needs.build-cli.result }}"
        echo "  - GitHub Release: ${{ needs.create-release.result }}"
        echo "  - Website Deploy: ${{ needs.deploy-web.result }}"
        echo "  - MCP Deploy: ${{ needs.deploy-mcp.result }}"
        echo ""
        echo "ðŸ”— Release: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.bump-version.outputs.new-version }}"
