name = "bspec-prod"
main = "dist/index.js"
compatibility_date = "2025-09-28"
compatibility_flags = ["nodejs_compat"]
# account_id is set via CLOUDFLARE_ACCOUNT_ID environment variable
workers_dev = true

# Workers configuration
[env.production]
name = "bspec-prod"
usage_model = "standard"

[[env.production.r2_buckets]]
binding = "ASSETS"
bucket_name = "bspec-assets"

[[env.production.durable_objects.bindings]]
name = "BSpecMcpAgent"
class_name = "BSpecMcpAgent"

# Custom domain configuration (replaces routes for Worker-as-origin)
[[env.production.routes]]
pattern = "mcp.bspec.dev"
custom_domain = true

[env.development]
name = "bspec-dev"
route = { pattern = "mcp-dev.bspec.dev/*", zone_name = "bspec.dev" }

[[env.development.r2_buckets]]
binding = "ASSETS"
bucket_name = "bspec-assets"

[[env.development.durable_objects.bindings]]
name = "BSpecMcpAgent"
class_name = "BSpecMcpAgent"

# Build configuration
[build]
command = "bun run build"

# Variables (add any required environment variables here)
[vars]
ENVIRONMENT = "development"
MCP_SERVER_VERSION = "1.0.0"
CORS_ORIGIN = "*"

# R2 bucket bindings for static assets
[[r2_buckets]]
binding = "ASSETS"
bucket_name = "bspec-assets"

# KV namespace bindings for caching (optional future enhancement)
# [[kv_namespaces]]
# binding = "BSPEC_CACHE"
# id = "your-kv-namespace-id"
# preview_id = "your-preview-kv-namespace-id"

# Durable Objects for BSpec MCP Agent
[[durable_objects.bindings]]
name = "BSpecMcpAgent"
class_name = "BSpecMcpAgent"

# Analytics Engine (for tracking usage)
# [[analytics_engine_datasets]]
# binding = "BSPEC_ANALYTICS"

# Limits and performance (CPU limits require paid plan)
# [limits]
# cpu_ms = 50  # 50ms CPU time limit per request (should be plenty for document parsing)

# Security headers
[env.production.vars]
ENVIRONMENT = "production"
MCP_SERVER_VERSION = "1.0.0"
CORS_ORIGIN = "*"
CSP_HEADER = "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' https://api.bspec.dev"

[env.development.vars]
ENVIRONMENT = "development"
MCP_SERVER_VERSION = "1.0.0"
CORS_ORIGIN = "*"
CSP_HEADER = "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' *"

# Wrangler AI (for future AI-powered enhancements)
# [ai]
# binding = "AI"

# Custom domains and routes (temporarily disabled for testing)
# [[routes]]
# pattern = "mcp.bspec.dev/*"
# zone_name = "bspec.dev"

# Development routes (temporarily disabled for testing)
# [[env.development.routes]]
# pattern = "mcp-dev.bspec.dev/*"
# zone_name = "bspec.dev"

# Observability and monitoring
[observability]
enabled = true

# Migration settings  
[[migrations]]
tag = "v1"
new_classes = []
renamed_classes = []
deleted_classes = []

# Migration for Durable Objects with SQLite  
[[migrations]]
tag = "v2"
# Mandatory for the Agent to store state (also adds the class)
new_sqlite_classes = ["BSpecMcpAgent"]
renamed_classes = []
deleted_classes = []
