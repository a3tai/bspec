# Server Hanging Issue - Root Cause Analysis

## Problem
`apps/docs` dev server hangs indefinitely when loading pages.

## Root Cause
**Sidebar.svelte uses deprecated `$app/stores` API incompatible with SvelteKit 2 + Svelte 5**

### Specific Issue
```typescript
// apps/docs/src/lib/components/Sidebar.svelte:2
import { page } from '$app/stores';  // ❌ DEPRECATED - causes SSR hang
const currentPath = $derived($page.url.pathname);  // ❌ Mixed old store + new runes
```

### Why It Fails
1. `$app/stores` is deprecated in SvelteKit 2
2. Using old stores with new Svelte 5 runes creates SSR incompatibility
3. Server-side rendering blocks waiting for store resolution
4. Dev server never completes initial page load

## Solution Implemented

### apps/docs-test: Clean Implementation
Created fresh SvelteKit app with proper Svelte 5 patterns:

✅ **Correct Load Functions**
```typescript
// +layout.ts and +page.ts use standard LayoutLoad/PageLoad
// No deprecated APIs, just plain data transformation
```

✅ **Static Data Generation**
- Copied `scripts/build-data.js`
- Generated JSON files in `src/lib/data/`
- Server runs without blocking

✅ **Dependencies**
```bash
bun add gray-matter marked marked-highlight highlight.js
```

## Verification
```bash
cd apps/docs-test
bun run build:data  # Generates static data
bun run dev         # Server starts in ~1s, no hanging
```

## Next Steps

### Option 1: Fix apps/docs (Recommended)
Fix the Sidebar component:

```typescript
// apps/docs/src/lib/components/Sidebar.svelte
import { page } from '$app/state';  // ✅ NEW API
const currentPath = $derived(page.url.pathname);  // ✅ No $ prefix
```

Additional fixes needed:
- Remove all `$app/stores` imports
- Convert writable stores to Svelte 5 runes
- Update theme-store.svelte.ts to use runes
- Test incrementally

### Option 2: Continue with apps/docs-test
Continue porting components to docs-test:

**Still Needed:**
- [ ] Copy `src/app.css` and styling
- [ ] Port ThemeToggle component (fix stores)
- [ ] Port Sidebar component (use `$app/state`)
- [ ] Port main layout
- [ ] Add domain routes
- [ ] Add document routes

**Migration Pattern:**
```typescript
// ❌ OLD (Svelte 4 + deprecated APIs)
import { writable } from 'svelte/store';
import { page } from '$app/stores';
export const theme = writable('light');
const path = $page.url.pathname;

// ✅ NEW (Svelte 5 runes + current APIs)
import { page } from '$app/state';
let theme = $state('light');
const path = $derived(page.url.pathname);
```

## Key Learnings

1. **SvelteKit 2 Breaking Change**: `$app/stores` removed, use `$app/state`
2. **Svelte 5 Runes**: No `$` prefix on state from `$app/state`
3. **Mixing Old + New**: Causes SSR hangs and incompatibilities
4. **Incremental Testing**: Start fresh, add complexity gradually
5. **Load Functions**: Always include error handling for missing data

## Files Modified in apps/docs-test

```
apps/docs-test/
├── package.json (added dependencies + build:data script)
├── scripts/
│   └── build-data.js (copied from apps/docs)
├── src/
│   ├── lib/
│   │   ├── bspec-types.ts (copied)
│   │   ├── navigation.ts (copied)
│   │   └── data/ (generated by build-data.js)
│   │       ├── home.json
│   │       ├── domains.json
│   │       ├── spec.json
│   │       ├── format.json
│   │       └── index.json
│   └── routes/
│       ├── +layout.ts (NEW - proper load function)
│       ├── +page.ts (NEW - proper load function)
│       └── +page.svelte (UPDATED - shows data)
└── PORT_PLAN.md (porting strategy)
```

## Recommendation

**Fix apps/docs** - it's faster than complete rewrite:

1. Update Sidebar.svelte to use `$app/state`
2. Convert theme stores to runes
3. Test after each change
4. Keep apps/docs-test as reference

**Estimated Time**: 30 minutes for core fixes, 1 hour for full testing

## References

- [SvelteKit 2 Migration Guide](https://kit.svelte.dev/docs/migrating-to-sveltekit-2)
- [Svelte 5 Runes](https://svelte.dev/docs/svelte/what-are-runes)
- [$app/state API](https://svelte-5-preview.vercel.app/docs/kit/$app-state)